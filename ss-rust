#!/bin/bash
set -e

# é…ç½®å˜é‡
CONFIG_DIR="/etc/shadowsocks-rust"
NODES_LIST="$CONFIG_DIR/nodes.list"
INSTALL_DIR="/usr/local/bin"
GITHUB_API="https://api.github.com/repos/shadowsocks/shadowsocks-rust/releases/latest"

# æ£€æŸ¥ root æƒé™
if [ "$EUID" -ne 0 ]; then
    echo "âŒ è¯·ä»¥ root ç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬"
    exit 1
fi

# å®‰è£…ä¾èµ–å‡½æ•°
install_dependencies() {
    echo "ğŸ”§ æ£€æŸ¥ä¾èµ–..."
    local MISSING=()
    declare -A pkg_commands=(
        ["curl"]="curl"
        ["jq"]="jq"
        ["xz-utils"]="xz"
        ["openssl"]="openssl"
        ["net-tools"]="ifconfig"
    )

    for pkg in "${!pkg_commands[@]}"; do
        command -v "${pkg_commands[$pkg]}" &>/dev/null || MISSING+=("$pkg")
    done

    if [ ${#MISSING[@]} -gt 0 ]; then
        echo "ğŸ“¥ å®‰è£…ç¼ºå¤±ä¾èµ–ï¼š${MISSING[*]}"
        apt-get update -y || { echo "é”™è¯¯ï¼šæ›´æ–° apt å¤±è´¥"; exit 1; }
        apt-get install -y --no-install-recommends "${MISSING[@]}" || { echo "é”™è¯¯ï¼šå®‰è£…ä¾èµ–å¤±è´¥"; exit 1; }
    else
        echo "â„¹ï¸ æ‰€æœ‰ä¾èµ–å·²å®‰è£…"
    fi
}

# åˆ›å»º Shadowsocks èŠ‚ç‚¹
create_node() {
    echo -e "\nğŸ“‹ åˆ›å»ºæ–° Shadowsocks èŠ‚ç‚¹"
    read -p "è¯·è¾“å…¥èŠ‚ç‚¹åç§°ï¼ˆç•™ç©ºè‡ªåŠ¨ç”Ÿæˆï¼‰ï¼š" NODE_NAME
    [ -z "$NODE_NAME" ] && NODE_NAME="node$(date +%s | tail -c 3)" && echo "â„¹ï¸ è‡ªåŠ¨ç”ŸæˆèŠ‚ç‚¹åç§°ï¼š$NODE_NAME"

    CONFIG_FILE="$CONFIG_DIR/node-$NODE_NAME.json"
    SERVICE_NAME="shadowsocks-rust-$NODE_NAME"

    if [ -f "$CONFIG_FILE" ]; then
        echo "âš ï¸ èŠ‚ç‚¹ $NODE_NAME å·²å­˜åœ¨"
        return 1
    fi

    mkdir -p "$CONFIG_DIR" && chmod 700 "$CONFIG_DIR"
    install_dependencies

    # é€‰æ‹©éšæœºç«¯å£
    for i in {1..10}; do
        PORT=$((RANDOM % 10000 + 10000))
        ss -tuln | grep -q ":$PORT\b" || break
        [ $i -eq 10 ] && { echo "é”™è¯¯ï¼šæ— æ³•æ‰¾åˆ°å¯ç”¨ç«¯å£"; exit 1; }
    done

    # ç”Ÿæˆé…ç½®
    PASSWORD=$(openssl rand -base64 12)
    METHOD="aes-256-gcm"
    LISTEN_ADDR="::"

    # ä¸‹è½½ Shadowsocks-Rustï¼ˆä»…åœ¨æœªå®‰è£…æ—¶ï¼‰
    if ! command -v ssserver &>/dev/null; then
        echo "ğŸ“¥ å®‰è£… Shadowsocks-Rust..."
        ARCH=$(uname -m)
        case "$ARCH" in
            x86_64) FILE="x86_64-unknown-linux-gnu.tar.xz" ;;
            aarch64) FILE="aarch64-unknown-linux-gnu.tar.xz" ;;
            *) echo "âŒ ä¸æ”¯æŒçš„æ¶æ„ $ARCH"; exit 1 ;;
        esac

        TMPDIR=$(mktemp -d)
        trap 'rm -rf "$TMPDIR"' EXIT
        cd "$TMPDIR"

        # è·å–æœ€æ–°ç‰ˆæœ¬
        RELEASE=$(curl -sSL "$GITHUB_API" || { echo "é”™è¯¯ï¼šæ— æ³•è®¿é—® GitHub API"; exit 1; })
        URL=$(echo "$RELEASE" | jq -r ".assets[] | select(.name | test(\"$FILE\")) | .browser_download_url")
        [ -z "$URL" ] && { echo "é”™è¯¯ï¼šæ— æ³•è·å–ä¸‹è½½ URL"; exit 1; }

        curl -L "$URL" -o ss.tar.xz || { echo "é”™è¯¯ï¼šä¸‹è½½ $URL å¤±è´¥"; exit 1; }
        tar -xf ss.tar.xz || { echo "é”™è¯¯ï¼šè§£å‹å¤±è´¥"; exit 1; }
        install -m 755 ssserver sslocal ssmanager "$INSTALL_DIR/" || { echo "é”™è¯¯ï¼šå®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶å¤±è´¥"; exit 1; }
        cd ~ && rm -rf "$TMPDIR"
    fi

    # å†™å…¥é…ç½®æ–‡ä»¶
    cat > "$CONFIG_FILE" <<EOF
{
    "server": "$LISTEN_ADDR",
    "server_port": $PORT,
    "password": "$PASSWORD",
    "method": "$METHOD",
    "mode": "tcp_and_udp"
}
EOF
    chmod 600 "$CONFIG_FILE"

    # åˆ›å»º systemd æœåŠ¡
    cat > "/etc/systemd/system/$SERVICE_NAME.service" <<EOF
[Unit]
Description=Shadowsocks-Rust Server ($NODE_NAME)
After=network.target

[Service]
Type=simple
ExecStart=$INSTALL_DIR/ssserver -c $CONFIG_FILE
Restart=always
User=nobody
Group=nogroup

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable --now "$SERVICE_NAME" || { echo "é”™è¯¯ï¼šå¯åŠ¨æœåŠ¡ $SERVICE_NAME å¤±è´¥"; exit 1; }

    # è·å–å…¬ç½‘ IP
    IP=$(curl -s https://api.ipify.org || curl -s https://ifconfig.me || echo "unknown")
    [ "$IP" = "unknown" ] && echo "âš ï¸ æ— æ³•è·å–å…¬ç½‘ IPï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"

    # ç”Ÿæˆè¿æ¥ä¿¡æ¯
    ENCODED=$(echo -n "$METHOD:$PASSWORD@$IP:$PORT" | base64 -w 0)
    echo "$NODE_NAME $PORT $PASSWORD $METHOD" >> "$NODES_LIST"

    echo -e "\nâœ… èŠ‚ç‚¹ $NODE_NAME éƒ¨ç½²æˆåŠŸ"
    echo "ğŸ“ é“¾æ¥: ss://${ENCODED}#${NODE_NAME}"
}

# åˆ é™¤ Shadowsocks èŠ‚ç‚¹
delete_node() {
    echo -e "\nğŸ§¹ åˆ é™¤ Shadowsocks èŠ‚ç‚¹"
    local NODES=()
    if [ -f "$NODES_LIST" ]; then
        mapfile -t NODES < <(cut -d ' ' -f1 "$NODES_LIST")
    else
        mapfile -t NODES < <(find "$CONFIG_DIR" -name 'node-*.json' -exec basename {} \; | sed 's/^node-//;s/\.json$//')
    fi

    if [ ${#NODES[@]} -eq 0 ]; then
        echo "âœ… å½“å‰æ— å¯åˆ é™¤çš„èŠ‚ç‚¹"
        return
    fi

    echo "ğŸ“‹ å½“å‰èŠ‚ç‚¹ï¼š"
    for i in "${!NODES[@]}"; do
        printf "  %2d) %s\n" $((i+1)) "${NODES[$i]}"
    done
    echo "   0) è¿”å›ä¸»èœå•"
    read -p "è¯·é€‰æ‹©è¦åˆ é™¤çš„èŠ‚ç‚¹ç¼–å·ï¼š" ID

    if [ "$ID" = "0" ]; then
        return
    elif [[ "$ID" =~ ^[0-9]+$ ]] && (( ID >= 1 && ID <= ${#NODES[@]} )); then
        NODE="${NODES[$((ID-1))]}"
        echo "ğŸ§¹ åˆ é™¤èŠ‚ç‚¹ $NODE..."
        systemctl stop "shadowsocks-rust-$NODE" 2>/dev/null || true
        systemctl disable "shadowsocks-rust-$NODE" 2>/dev/null || true
        rm -f "/etc/systemd/system/shadowsocks-rust-$NODE.service" "$CONFIG_DIR/node-$NODE.json"
        [ -f "$NODES_LIST" ] && sed -i "/^$NODE /d" "$NODES_LIST"
        systemctl daemon-reload
        echo "âœ… èŠ‚ç‚¹ $NODE å·²åˆ é™¤"
    else
        echo "âŒ æ— æ•ˆç¼–å·"
    fi
}

# ä¸»èœå•
while true; do
    echo -e "\nğŸ§­ Shadowsocks-Rust ç®¡ç†èœå•"
    echo "1) åˆ›å»º Shadowsocks èŠ‚ç‚¹"
    echo "2) åˆ é™¤ Shadowsocks èŠ‚ç‚¹"
    echo "0) é€€å‡º"
    read -p "è¯·è¾“å…¥æ“ä½œç¼–å·ï¼š" CHOICE
    case "$CHOICE" in
        1) create_node ;;
        2) delete_node ;;
        0) echo "ğŸ‘‹ å†è§ï¼"; exit 0 ;;
        *) echo "âŒ æ— æ•ˆé€‰é¡¹" ;;
    esac
done
