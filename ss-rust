#!/bin/bash
set -e

# æ£€æŸ¥ root æƒé™
if [ "$EUID" -ne 0 ]; then
    echo "âŒ è¯·ä»¥ root æƒé™è¿è¡Œæ­¤è„šæœ¬"
    exit 1
fi

# çº¯ bash å®ç° URL ç¼–ç 
urlencode() {
    local length="${#1}"
    local i c
    for (( i = 0; i < length; i++ )); do
        c="${1:i:1}"
        case "$c" in
            [a-zA-Z0-9.~_-]) printf "$c" ;;
            *) printf '%%%02X' "'$c" ;;
        esac
    done
}

# è¯»å–ç”¨æˆ·è¾“å…¥çš„èŠ‚ç‚¹åç§°
read -p "è¯·è¾“å…¥èŠ‚ç‚¹åç§°ï¼ˆç”¨äº ss:// é“¾æ¥æ˜¾ç¤ºï¼‰: " NODE_NAME
NODE_NAME_ENCODED=$(urlencode "$NODE_NAME")

# æ£€æŸ¥å¹¶å®‰è£…ä¾èµ–
install_if_missing() {
    if ! command -v "$1" >/dev/null 2>&1; then
        echo "ğŸ”§ æ­£åœ¨å®‰è£…ä¾èµ–ï¼š$1"
        if command -v apt >/dev/null 2>&1; then
            apt update && apt install -y --no-install-recommends "$1"
        elif command -v yum >/dev/null 2>&1; then
            yum install -y epel-release && yum install -y "$1"
        elif command -v apk >/dev/null 2>&1; then
            apk add "$1"
        else
            echo "âŒ æ— æ³•å®‰è£… $1ï¼Œè¯·æ‰‹åŠ¨å®‰è£…åé‡è¯•"
            exit 1
        fi
    fi
}
install_if_missing curl
install_if_missing jq
install_if_missing xz-utils
install_if_missing openssl

# ç”Ÿæˆéšæœºé…ç½®
PORT=$((RANDOM % 10000 + 10000))
PASSWORD=$(openssl rand -base64 12)
METHOD="aes-256-gcm"

# åˆ¤æ–­ IPv6 æ”¯æŒ
if [ -f /proc/net/if_inet6 ]; then
    HAS_IPV6=true
    LISTEN_ADDR="::"
else
    HAS_IPV6=false
    LISTEN_ADDR="0.0.0.0"
fi

# ä¸‹è½½å¹¶å®‰è£… Shadowsocks-Rust
LATEST_URL=$(curl -s https://api.github.com/repos/shadowsocks/shadowsocks-rust/releases/latest | \
    jq -r '.assets[] | select(.name | test("x86_64-unknown-linux-gnu.tar.xz")) | .browser_download_url')
if [[ -z "$LATEST_URL" ]]; then
    echo "âŒ æ— æ³•è·å– Shadowsocks-Rust ä¸‹è½½é“¾æ¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– GitHub API"
    exit 1
fi

mkdir -p /opt/ss-rust && cd /opt/ss-rust
curl -L "$LATEST_URL" -o ss-rust.tar.xz
tar -xJf ss-rust.tar.xz
install sslocal ssserver ssmanager /usr/local/bin/
rm -f ss-rust.tar.xz

# éªŒè¯å®‰è£…
for bin in sslocal ssserver ssmanager; do
    if ! [ -x "/usr/local/bin/$bin" ]; then
        echo "âŒ $bin å®‰è£…å¤±è´¥"
        exit 1
    fi
done

# æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
if [ -f /etc/shadowsocks-rust.json ]; then
    read -p "âš ï¸ é…ç½®æ–‡ä»¶å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ[y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# åˆ›å»ºé…ç½®æ–‡ä»¶
cat > /etc/shadowsocks-rust.json <<EOF
{
    "server": "$LISTEN_ADDR",
    "server_port": $PORT,
    "password": "$PASSWORD",
    "method": "$METHOD",
    "mode": "tcp_and_udp"
}
EOF
chmod 600 /etc/shadowsocks-rust.json

# åˆ›å»º systemd æœåŠ¡
cat > /etc/systemd/system/shadowsocks-rust.service <<EOF
[Unit]
Description=Shadowsocks Rust Server
After=network.target

[Service]
ExecStart=/usr/local/bin/ssserver -c /etc/shadowsocks-rust.json
Restart=always

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reexec
systemctl daemon-reload
systemctl enable --now shadowsocks-rust

# éªŒè¯æœåŠ¡çŠ¶æ€
if ! systemctl is-active --quiet shadowsocks-rust; then
    echo "âŒ Shadowsocks-Rust æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ systemctl status shadowsocks-rust"
    exit 1
fi

# è·å–å…¬ç½‘ IPï¼ˆä¼˜å…ˆ IPv4ï¼‰
IP=$(curl -s -4 https://api64.ipify.org)
if [[ -z "$IP" ]]; then
    IP=$(curl -s -6 https://api64.ipify.org)
fi
if [[ ! "$IP" =~ ^[0-9.:]+$ ]]; then
    echo "âŒ æ— æ³•è·å–æœ‰æ•ˆå…¬ç½‘ IPï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"
    exit 1
fi

# æ„å»ºæ ‡å‡† ss:// é“¾æ¥
ENCODED=$(echo -n "$METHOD:$PASSWORD@$IP:$PORT" | base64 | tr -d '\n')
SS_LINK="ss://$ENCODED#$NODE_NAME_ENCODED"

# è¾“å‡ºèŠ‚ç‚¹ä¿¡æ¯å’Œé“¾æ¥
echo -e "\nâœ… Shadowsocks-Rust å·²éƒ¨ç½²æˆåŠŸ"
echo "-------------------------------------"
echo "åœ°å€: $IP"
echo "ç«¯å£: $PORT"
echo "å¯†ç : $PASSWORD"
echo "åŠ å¯†: $METHOD"
echo "IPv6 æ”¯æŒ: $HAS_IPV6"
echo -e "\nğŸ“ æ ‡å‡†é“¾æ¥ï¼š\n$SS_LINK"
