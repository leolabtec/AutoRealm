#!/bin/bash
set -e

CONFIG_DIR="/etc/shadowsocks-rust"
NODES_LIST="$CONFIG_DIR/nodes.list"

# æ£€æŸ¥ root æƒé™
if [ "$EUID" -ne 0 ]; then
    echo "âŒ è¯·ä»¥ root ç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬"
    exit 1
fi

# ä¼˜åŒ–åçš„ä¾èµ–å®‰è£…å‡½æ•°
install_dependencies() {
    local MISSING=()
    declare -A pkg_commands=(
        ["curl"]="curl"
        ["jq"]="jq"
        ["xz-utils"]="xz"
        ["openssl"]="openssl"
        ["net-tools"]="ifconfig"
    )

    for pkg in "${!pkg_commands[@]}"; do
        if ! command -v "${pkg_commands[$pkg]}" &>/dev/null; then
            MISSING+=("$pkg")
        fi
    done

    if (( ${#MISSING[@]} > 0 )); then
        echo "ğŸ”§ æ£€æµ‹åˆ°ä»¥ä¸‹ä¾èµ–ç¼ºå¤±ï¼š${MISSING[*]}"
        apt update -y
        apt install -y --no-install-recommends "${MISSING[@]}"
    else
        echo "â„¹ï¸ æ‰€æœ‰ä¾èµ–å·²å®‰è£…ï¼Œæ— éœ€æ›´æ–°"
    fi
}

# åˆ›å»º Shadowsocks èŠ‚ç‚¹
create_node() {
    echo
    read -p "è¯·è¾“å…¥èŠ‚ç‚¹åç§°ï¼ˆå¯ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆï¼‰ï¼š" NODE_NAME
    if [[ -z "$NODE_NAME" ]]; then
        NODE_NAME="node$(date +%s | tail -c 3)"
        echo "â„¹ï¸ è‡ªåŠ¨ç”ŸæˆèŠ‚ç‚¹åç§°ï¼š$NODE_NAME"
    fi
    CONFIG_FILE="${CONFIG_DIR}/node-${NODE_NAME}.json"
    SERVICE_NAME="shadowsocks-rust-${NODE_NAME}"

    if [[ -f "$CONFIG_FILE" ]]; then
        echo "âš ï¸ èŠ‚ç‚¹ $NODE_NAME å·²å­˜åœ¨"
        return
    fi

    mkdir -p "$CONFIG_DIR"
    chmod 700 "$CONFIG_DIR"

    install_dependencies

    # éšæœºç«¯å£
    for i in {1..10}; do
        PORT=$((RANDOM % 10000 + 10000))
        ss -tuln | grep -q ":$PORT\b" || break
    done

    PASSWORD=$(openssl rand -base64 12)
    METHOD="aes-256-gcm"
    LISTEN_ADDR="::"

    # ä¸‹è½½ Shadowsocks-Rustï¼ˆäºŒè¿›åˆ¶ï¼‰åªä¸€æ¬¡
    if ! command -v ssserver &>/dev/null; then
        echo "ğŸ“¥ å®‰è£… Shadowsocks-Rust..."
        ARCH=$(uname -m)
        case "$ARCH" in
            x86_64) FILE="x86_64-unknown-linux-gnu.tar.xz" ;;
            aarch64) FILE="aarch64-unknown-linux-gnu.tar.xz" ;;
            *) echo "âŒ ä¸æ”¯æŒæ¶æ„ $ARCH" && exit 1 ;;
        esac

        TMPDIR=$(mktemp -d)
        cd "$TMPDIR"
        RELEASE=$(curl -s https://api.github.com/repos/shadowsocks/shadowsocks-rust/releases/latest)
        URL=$(echo "$RELEASE" | jq -r ".assets[] | select(.name | test(\"$FILE\")) | .browser_download_url")
        curl -L "$URL" -o ss.tar.xz
        tar -xf ss.tar.xz
        install ssserver sslocal ssmanager /usr/local/bin/
        cd ~ && rm -rf "$TMPDIR"
    fi

    # å†™é…ç½®
    cat > "$CONFIG_FILE" <<EOF
{
    "server": "$LISTEN_ADDR",
    "server_port": $PORT,
    "password": "$PASSWORD",
    "method": "$METHOD",
    "mode": "tcp_and_udp"
}
EOF
    chmod 600 "$CONFIG_FILE"

    # å†™æœåŠ¡
    cat > "/etc/systemd/system/${SERVICE_NAME}.service" <<EOF
[Unit]
Description=Shadowsocks Rust Server ($NODE_NAME)
After=network.target

[Service]
ExecStart=/usr/local/bin/ssserver -c $CONFIG_FILE
Restart=always

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable --now "$SERVICE_NAME"

    # è·å–å…¬ç½‘ IP
    IP=$(curl -s https://api.ipify.org || curl -s https://ifconfig.me)

    # æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
    ENCODED=$(echo -n "$METHOD:$PASSWORD@$IP:$PORT" | base64)
    echo "$NODE_NAME $PORT $PASSWORD $METHOD" >> "$NODES_LIST"

    echo -e "\nâœ… Shadowsocks-Rust èŠ‚ç‚¹å·²éƒ¨ç½²æˆåŠŸ"
    echo "ğŸ“ é“¾æ¥: ss://${ENCODED}#${NODE_NAME}"
}

# åˆ é™¤ Shadowsocks èŠ‚ç‚¹
delete_node() {
    while true; do
        echo
        declare -a NODES
        if [[ -f "$NODES_LIST" ]]; then
            mapfile -t NODES < <(cut -d ' ' -f1 "$NODES_LIST")
        else
            mapfile -t NODES < <(find "$CONFIG_DIR" -name 'node-*.json' -exec basename {} \; | sed 's/^node-//;s/\.json$//')
        fi

        if [[ ${#NODES[@]} -eq 0 ]]; then
            echo "âœ… å½“å‰å·²æ— å¯åˆ é™¤çš„ Shadowsocks èŠ‚ç‚¹ï¼Œè¿”å›ä¸»èœå•ã€‚"
            return
        fi

        echo "ğŸ“‹ å½“å‰å¯åˆ é™¤çš„èŠ‚ç‚¹ï¼š"
        for i in "${!NODES[@]}"; do
            printf "  %2d) %s\n" $((i+1)) "${NODES[$i]}"
        done
        echo "   0) è¿”å›ä¸»èœå•"
        read -p "è¯·é€‰æ‹©è¦åˆ é™¤çš„èŠ‚ç‚¹ç¼–å·ï¼š" ID

        if [[ "$ID" == "0" ]]; then
            return
        elif [[ "$ID" =~ ^[0-9]+$ ]] && (( ID >= 1 && ID <= ${#NODES[@]} )); then
            NODE="${NODES[$((ID-1))]}"
            echo "ğŸ§¹ æ­£åœ¨åˆ é™¤èŠ‚ç‚¹ $NODE..."
            systemctl stop "shadowsocks-rust-$NODE" || true
            systemctl disable "shadowsocks-rust-$NODE" || true
            rm -f "/etc/systemd/system/shadowsocks-rust-${NODE}.service"
            rm -f "$CONFIG_DIR/node-${NODE}.json"
            [[ -f "$NODES_LIST" ]] && sed -i "/^$NODE /d" "$NODES_LIST"
            systemctl daemon-reload
            echo "âœ… èŠ‚ç‚¹ $NODE å·²åˆ é™¤"
        else
            echo "âŒ æ— æ•ˆç¼–å·"
        fi
    done
}

# ä¸»èœå•å¾ªç¯
while true; do
    echo -e "\nğŸ§­ Shadowsocks-Rust ç®¡ç†èœå•"
    echo "1) åˆ›å»º Shadowsocks èŠ‚ç‚¹"
    echo "2) åˆ é™¤ Shadowsocks èŠ‚ç‚¹"
    echo "0) é€€å‡º"
    read -p "è¯·è¾“å…¥æ“ä½œç¼–å·ï¼š" CHOICE
    case "$CHOICE" in
        1) create_node ;;
        2) delete_node ;;
        0) echo "ğŸ‘‹ å†è§ï¼"; exit 0 ;;
        *) echo "âŒ æ— æ•ˆé€‰é¡¹" ;;
    esac
done
