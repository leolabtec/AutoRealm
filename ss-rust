#!/bin/bash
set -e

# æ£€æŸ¥ root æƒé™
if [ "$EUID" -ne 0 ]; then
    echo "âŒ è¯·ä»¥ root æƒé™è¿è¡Œæ­¤è„šæœ¬"
    exit 1
fi

# çº¯ bash å®ç° URL ç¼–ç 
urlencode() {
    local length="${#1}"
    local i c
    for (( i = 0; i < length; i++ )); do
        c="${1:i:1}"
        case "$c" in
            [a-zA-Z0-9.~_-]) printf "$c" ;;
            *) printf '%%%02X' "'$c" ;;
        esac
    done
}

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼ˆTCP å’Œ UDPï¼‰
check_port() {
    local port=$1
    if command -v ss >/dev/null 2>&1; then
        if ss -tuln | grep -q ":${port}\b"; then
            return 1
        fi
    elif command -v netstat >/dev/null 2>&1; then
        if netstat -tuln | grep -q ":${port}\b"; then
            return 1
        fi
    else
        echo "âš ï¸ æœªæ‰¾åˆ° ss æˆ– netstatï¼Œæ— æ³•æ£€æŸ¥ç«¯å£å ç”¨ï¼Œå°†ç»§ç»­ä½¿ç”¨ç«¯å£ $port"
        return 0
    fi
    return 0
}

# è¯»å–ç”¨æˆ·è¾“å…¥çš„èŠ‚ç‚¹åç§°
read -p "è¯·è¾“å…¥èŠ‚ç‚¹åç§°ï¼ˆç”¨äº ss:// é“¾æ¥æ˜¾ç¤ºï¼Œå»ºè®®ä½¿ç”¨å”¯ä¸€åç§°å¦‚ node1ã€node2ï¼‰ï¼š" NODE_NAME
if [[ -z "$NODE_NAME" ]]; then
    echo "âŒ èŠ‚ç‚¹åç§°ä¸èƒ½ä¸ºç©º"
    exit 1
fi
NODE_NAME_ENCODED=$(urlencode "$NODE_NAME")
CONFIG_DIR="/etc/shadowsocks-rust"
CONFIG_FILE="${CONFIG_DIR}/node-${NODE_NAME}.json"
SERVICE_NAME="shadowsocks-rust-${NODE_NAME}"

# æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å·²å­˜åœ¨
if [ -f "$CONFIG_FILE" ]; then
    read -p "âš ï¸ èŠ‚ç‚¹ ${NODE_NAME} çš„é…ç½®æ–‡ä»¶å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ[y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# åˆ›å»ºé…ç½®ç›®å½•
mkdir -p "$CONFIG_DIR"
chmod 700 "$CONFIG_DIR"

# æ£€æŸ¥å¹¶å®‰è£…ä¾èµ–
install_if_missing() {
    if ! command -v "$1" >/dev/null 2>&1; then
        echo "ğŸ”§ æ­£åœ¨å®‰è£…ä¾èµ–ï¼š$1"
        if command -v apt >/dev/null 2>&1; then
            apt update -y && apt install -y --no-install-recommends "$1"
        elif command -v yum >/dev/null 2>&1; then
            yum install -y epel-release && yum install -y "$1"
        elif command -v apk >/dev/null 2>&1; then
            apk add "$1"
        else
            echo "âŒ æ— æ³•å®‰è£… $1ï¼Œè¯·æ‰‹åŠ¨å®‰è£…åé‡è¯•"
            exit 1
        fi
    fi
}
install_if_missing curl
install_if_missing jq
install_if_missing xz-utils
install_if_missing openssl
install_if_missing net-tools

# ç”Ÿæˆéšæœºç«¯å£å¹¶æ£€æŸ¥æ˜¯å¦è¢«å ç”¨
MAX_ATTEMPTS=10
ATTEMPT=1
while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
    PORT=$((RANDOM % 10000 + 10000))
    echo "ğŸ” æ£€æŸ¥ç«¯å£ $PORT æ˜¯å¦å¯ç”¨..."
    if check_port $PORT; then
        echo "âœ… ç«¯å£ $PORT å¯ç”¨"
        break
    else
        echo "âš ï¸ ç«¯å£ $PORT å·²è¢«å ç”¨ï¼Œå°è¯•ä¸‹ä¸€ä¸ªç«¯å£..."
        ATTEMPT=$((ATTEMPT + 1))
        if [ $ATTEMPT -gt $MAX_ATTEMPTS ]; then
            echo "âŒ æ— æ³•æ‰¾åˆ°å¯ç”¨ç«¯å£ï¼Œè¯·æ‰‹åŠ¨æŒ‡å®šç«¯å£æˆ–é‡Šæ”¾å ç”¨ç«¯å£"
            exit 1
        fi
    fi
done

# ç”Ÿæˆå…¶ä»–é…ç½®
PASSWORD=$(openssl rand -base64 12)
METHOD="aes-256-gcm"

# åˆ¤æ–­ IPv6 æ”¯æŒ
if [ -f /proc/net/if_inet6 ]; then
    HAS_IPV6=true
    LISTEN_ADDR="::"
else
    HAS_IPV6=false
    LISTEN_ADDR="0.0.0.0"
fi

# æ£€æµ‹æœåŠ¡å™¨æ¶æ„
ARCH=$(uname -m)
case "$ARCH" in
    x86_64)
        ASSET_FILTER="x86_64-unknown-linux-gnu.tar.xz$"
        ;;
    aarch64)
        ASSET_FILTER="aarch64-unknown-linux-gnu.tar.xz$"
        ;;
    *)
        echo "âŒ ä¸æ”¯æŒçš„æ¶æ„ï¼š$ARCH"
        exit 1
        ;;
esac

# ä¸‹è½½å¹¶å®‰è£… Shadowsocks-Rustï¼ˆä»…åœ¨é¦–æ¬¡è¿è¡Œæ—¶å®‰è£…ï¼‰
if ! [ -x "/usr/local/bin/ssserver" ]; then
    echo "ğŸ” è·å– Shadowsocks-Rust æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯..."
    RELEASE_JSON=$(curl -s -f --connect-timeout 10 https://api.github.com/repos/shadowsocks/shadowsocks-rust/releases/latest 2>/dev/null)
    if [[ $? -ne 0 || -z "$RELEASE_JSON" ]]; then
        echo "âŒ æ— æ³•è®¿é—® GitHub APIï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– GitHub API çŠ¶æ€"
        exit 1
    fi

    # è°ƒè¯•ï¼šè¾“å‡ºèµ„äº§åˆ—è¡¨
    echo "$RELEASE_JSON" | jq -r '.assets[].name' > assets.txt
    echo "ğŸ“„ å¯ç”¨èµ„äº§åˆ—è¡¨ï¼š"
    cat assets.txt

    # æå– .tar.xz æ–‡ä»¶çš„ä¸‹è½½é“¾æ¥ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰
    LATEST_URL=$(echo "$RELEASE_JSON" | jq -r ".assets[] | select(.name | test(\"$ASSET_FILTER\")) | .browser_download_url" | head -n 1 | tr -d '\n\r' | sed 's/[^a-zA-Z0-9:/.?-]//g')
    if [[ -z "$LATEST_URL" ]]; then
        echo "âŒ æœªæ‰¾åˆ°é€‚ç”¨äº $ARCH çš„ Shadowsocks-Rust èµ„äº§ ($ASSET_FILTER)"
        echo "è¯·æ£€æŸ¥ GitHub å‘å¸ƒé¡µé¢ï¼šhttps://github.com/shadowsocks/shadowsocks-rust/releases"
        exit 1
    fi
    echo "ğŸ“¥ ä¸‹è½½é“¾æ¥ï¼š$LATEST_URL"

    # è°ƒè¯•ï¼šæ£€æŸ¥ URL å­—ç¬¦å†…å®¹
    echo "ğŸ” æ£€æŸ¥ URL å­—ç¬¦å†…å®¹ï¼š"
    od -c <<< "$LATEST_URL"

    # ä¸‹è½½æ ¡éªŒå’Œæ–‡ä»¶
    SHA256_URL="${LATEST_URL}.sha256"
    curl -L -f --connect-timeout 10 "$SHA256_URL" -o ss-rust.tar.xz.sha256 || echo "âš ï¸ æ— æ³•ä¸‹è½½æ ¡éªŒå’Œæ–‡ä»¶ï¼Œç»§ç»­ä½†ä¸éªŒè¯æ–‡ä»¶å®Œæ•´æ€§"

    # ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶
    mkdir -p /opt/ss-rust && cd /opt/ss-rust
    curl -L -f --connect-timeout 10 "$LATEST_URL" -o ss-rust.tar.xz
    if [[ $? -ne 0 ]]; then
        echo "âŒ ä¸‹è½½ Shadowsocks-Rust å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– URL"
        exit 1
    fi

    # éªŒè¯æ ¡éªŒå’Œï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if [ -f ss-rust.tar.xz.sha256 ]; then
        echo "ğŸ” éªŒè¯æ–‡ä»¶å®Œæ•´æ€§..."
        if ! echo "$(cat ss-rust.tar.xz.sha256) ss-rust.tar.xz" | sha256sum -c --status; then
            echo "âŒ æ ¡éªŒå’ŒéªŒè¯å¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½å·²æŸå"
            rm -f ss-rust.tar.xz ss-rust.tar.xz.sha256
            exit 1
        fi
        echo "âœ… æ ¡éªŒå’ŒéªŒè¯é€šè¿‡"
        rm -f ss-rust.tar.xz.sha256
    fi

    tar -xJf ss-rust.tar.xz
    install sslocal ssserver ssmanager /usr/local/bin/
    rm -f ss-rust.tar.xz
fi

# éªŒè¯å®‰è£…
for bin in sslocal ssserver ssmanager; do
    if ! [ -x "/usr/local/bin/$bin" ]; then
        echo "âŒ $bin å®‰è£…å¤±è´¥"
        exit 1
    fi
done

# åˆ›å»ºé…ç½®æ–‡ä»¶
cat > "$CONFIG_FILE" <<EOF
{
    "server": "$LISTEN_ADDR",
    "server_port": $PORT,
    "password": "$PASSWORD",
    "method": "$METHOD",
    "mode": "tcp_and_udp"
}
EOF
chmod 600 "$CONFIG_FILE"

# åˆ›å»º systemd æœåŠ¡
cat > "/etc/systemd/system/${SERVICE_NAME}.service" <<EOF
[Unit]
Description=Shadowsocks Rust Server ($NODE_NAME)
After=network.target

[Service]
ExecStart=/usr/local/bin/ssserver -c $CONFIG_FILE
Restart=always

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reexec
systemctl daemon-reload
systemctl enable --now "$SERVICE_NAME"

# éªŒè¯æœåŠ¡çŠ¶æ€
if ! systemctl is-active --quiet "$SERVICE_NAME"; then
    echo "âŒ Shadowsocks-Rust æœåŠ¡ ($SERVICE_NAME) å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ systemctl status $SERVICE_NAME"
    exit 1
fi

# è·å–å…¬ç½‘ IPï¼ˆä¼˜å…ˆ IPv4ï¼‰
IP=$(curl -s -4 --connect-timeout 5 https://api64.ipify.org)
if [[ -z "$IP" ]]; then
    IP=$(curl -s -6 --connect-timeout 5 https://api64.ipify.org)
fi
if [[ ! "$IP" =~ ^[0-9.:]+$ ]]; then
    echo "âŒ æ— æ³•è·å–æœ‰æ•ˆå…¬ç½‘ IPï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"
    exit 1
fi

# æ„å»ºæ ‡å‡† ss:// é“¾æ¥
ENCODED=$(echo -n "$METHOD:$PASSWORD@$IP:$PORT" | base64 | tr -d '\n')
SS_LINK="ss://$ENCODED#$NODE_NAME_ENCODED"

# è¾“å‡ºèŠ‚ç‚¹ä¿¡æ¯å’Œé“¾æ¥
echo -e "\nâœ… Shadowsocks-Rust èŠ‚ç‚¹ ($NODE_NAME) å·²éƒ¨ç½²æˆåŠŸ"
echo "-------------------------------------"
echo "èŠ‚ç‚¹åç§°: $NODE_NAME"
echo "åœ°å€: $IP"
echo "ç«¯å£: $PORT"
echo "å¯†ç : $PASSWORD"
echo "åŠ å¯†: $METHOD"
echo "IPv6 æ”¯æŒ: $HAS_IPV6"
echo "é…ç½®æ–‡ä»¶: $CONFIG_FILE"
echo "æœåŠ¡åç§°: $SERVICE_NAME"
echo -e "\nğŸ“ æ ‡å‡†é“¾æ¥ï¼š\n$SS_LINK"
