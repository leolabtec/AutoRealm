#!/bin/bash
set -e

# 检查 root 权限
if [ "$EUID" -ne 0 ]; then
    echo "❌ 请以 root 权限运行此脚本"
    exit 1
fi

# 纯 bash 实现 URL 编码
urlencode() {
    local length="${#1}"
    local i c
    for (( i = 0; i < length; i++ )); do
        c="${1:i:1}"
        case "$c" in
            [a-zA-Z0-9.~_-]) printf "$c" ;;
            *) printf '%%%02X' "'$c" ;;
        esac
    done
}

# 检查端口是否被占用（TCP 和 UDP）
check_port() {
    local port=$1
    if command -v ss >/dev/null 2>&1; then
        if ss -tuln | grep -q ":${port}\b"; then
            return 1
        fi
    elif command -v netstat >/dev/null 2>&1; then
        if netstat -tuln | grep -q ":${port}\b"; then
            return 1
        fi
    else
        echo "⚠️ 未找到 ss 或 netstat，无法检查端口占用，将继续使用端口 $port"
        return 0
    fi
    return 0
}

# 读取用户输入的节点名称
read -p "请输入节点名称（用于 ss:// 链接显示，建议使用唯一名称如 node1、node2）：" NODE_NAME
if [[ -z "$NODE_NAME" ]]; then
    echo "❌ 节点名称不能为空"
    exit 1
fi
NODE_NAME_ENCODED=$(urlencode "$NODE_NAME")
CONFIG_DIR="/etc/shadowsocks-rust"
CONFIG_FILE="${CONFIG_DIR}/node-${NODE_NAME}.json"
SERVICE_NAME="shadowsocks-rust-${NODE_NAME}"

# 检查节点是否已存在
if [ -f "$CONFIG_FILE" ]; then
    read -p "⚠️ 节点 ${NODE_NAME} 的配置文件已存在，是否覆盖？[y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# 创建配置目录
mkdir -p "$CONFIG_DIR"
chmod 700 "$CONFIG_DIR"

# 检查并安装依赖
install_if_missing() {
    if ! command -v "$1" >/dev/null 2>&1; then
        echo "🔧 正在安装依赖：$1"
        if command -v apt >/dev/null 2>&1; then
            apt update -y && apt install -y --no-install-recommends "$1"
        elif command -v yum >/dev/null 2>&1; then
            yum install -y epel-release && yum install -y "$1"
        elif command -v apk >/dev/null 2>&1; then
            apk add "$1"
        else
            echo "❌ 无法安装 $1，请手动安装后重试"
            exit 1
        fi
    fi
}
install_if_missing curl
install_if_missing jq
install_if_missing xz-utils
install_if_missing openssl
install_if_missing net-tools

# 生成随机端口并检查是否被占用
MAX_ATTEMPTS=10
ATTEMPT=1
while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
    PORT=$((RANDOM % 10000 + 10000))
    echo "🔍 检查端口 $PORT 是否可用..."
    if check_port $PORT; then
        echo "✅ 端口 $PORT 可用"
        break
    else
        echo "⚠️ 端口 $PORT 已被占用，尝试下一个端口..."
        ATTEMPT=$((ATTEMPT + 1))
        if [ $ATTEMPT -gt $MAX_ATTEMPTS ]; then
            echo "❌ 无法找到可用端口，请手动指定端口或释放占用端口"
            exit 1
        fi
    fi
done

# 生成其他配置
PASSWORD=$(openssl rand -base64 12)
METHOD="aes-256-gcm"

# 判断 IPv6 支持
if [ -f /proc/net/if_inet6 ]; then
    HAS_IPV6=true
    LISTEN_ADDR="::"
else
    HAS_IPV6=false
    LISTEN_ADDR="0.0.0.0"
fi

# 检测服务器架构
ARCH=$(uname -m)
case "$ARCH" in
    x86_64)
        ASSET_FILTER="x86_64-unknown-linux-gnu.tar.xz$"
        ;;
    aarch64)
        ASSET_FILTER="aarch64-unknown-linux-gnu.tar.xz$"
        ;;
    *)
        echo "❌ 不支持的架构：$ARCH"
        exit 1
        ;;
esac

# 下载并安装 Shadowsocks-Rust（仅在首次运行时安装）
if ! [ -x "/usr/local/bin/ssserver" ]; then
    echo "🔍 获取 Shadowsocks-Rust 最新版本信息..."
    RELEASE_JSON=$(curl -s -f --connect-timeout 10 https://api.github.com/repos/shadowsocks/shadowsocks-rust/releases/latest 2>/dev/null)
    if [[ $? -ne 0 || -z "$RELEASE_JSON" ]]; then
        echo "❌ 无法访问 GitHub API，请检查网络连接或 GitHub API 状态"
        exit 1
    fi

    # 调试：输出资产列表
    echo "$RELEASE_JSON" | jq -r '.assets[].name' > assets.txt
    echo "📄 可用资产列表："
    cat assets.txt

    # 提取 .tar.xz 文件的下载链接（精确匹配）
    LATEST_URL=$(echo "$RELEASE_JSON" | jq -r ".assets[] | select(.name | test(\"$ASSET_FILTER\")) | .browser_download_url" | head -n 1 | tr -d '\n\r' | sed 's/[^a-zA-Z0-9:/.?-]//g')
    if [[ -z "$LATEST_URL" ]]; then
        echo "❌ 未找到适用于 $ARCH 的 Shadowsocks-Rust 资产 ($ASSET_FILTER)"
        echo "请检查 GitHub 发布页面：https://github.com/shadowsocks/shadowsocks-rust/releases"
        exit 1
    fi
    echo "📥 下载链接：$LATEST_URL"

    # 调试：检查 URL 字符内容
    echo "🔍 检查 URL 字符内容："
    od -c <<< "$LATEST_URL"

    # 下载校验和文件
    SHA256_URL="${LATEST_URL}.sha256"
    curl -L -f --connect-timeout 10 "$SHA256_URL" -o ss-rust.tar.xz.sha256 || echo "⚠️ 无法下载校验和文件，继续但不验证文件完整性"

    # 下载二进制文件
    mkdir -p /opt/ss-rust && cd /opt/ss-rust
    curl -L -f --connect-timeout 10 "$LATEST_URL" -o ss-rust.tar.xz
    if [[ $? -ne 0 ]]; then
        echo "❌ 下载 Shadowsocks-Rust 失败，请检查网络或 URL"
        exit 1
    fi

    # 验证校验和（如果存在）
    if [ -f ss-rust.tar.xz.sha256 ]; then
        echo "🔍 验证文件完整性..."
        if ! echo "$(cat ss-rust.tar.xz.sha256) ss-rust.tar.xz" | sha256sum -c --status; then
            echo "❌ 校验和验证失败，文件可能已损坏"
            rm -f ss-rust.tar.xz ss-rust.tar.xz.sha256
            exit 1
        fi
        echo "✅ 校验和验证通过"
        rm -f ss-rust.tar.xz.sha256
    fi

    tar -xJf ss-rust.tar.xz
    install sslocal ssserver ssmanager /usr/local/bin/
    rm -f ss-rust.tar.xz
fi

# 验证安装
for bin in sslocal ssserver ssmanager; do
    if ! [ -x "/usr/local/bin/$bin" ]; then
        echo "❌ $bin 安装失败"
        exit 1
    fi
done

# 创建配置文件
cat > "$CONFIG_FILE" <<EOF
{
    "server": "$LISTEN_ADDR",
    "server_port": $PORT,
    "password": "$PASSWORD",
    "method": "$METHOD",
    "mode": "tcp_and_udp"
}
EOF
chmod 600 "$CONFIG_FILE"

# 创建 systemd 服务
cat > "/etc/systemd/system/${SERVICE_NAME}.service" <<EOF
[Unit]
Description=Shadowsocks Rust Server ($NODE_NAME)
After=network.target

[Service]
ExecStart=/usr/local/bin/ssserver -c $CONFIG_FILE
Restart=always

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reexec
systemctl daemon-reload
systemctl enable --now "$SERVICE_NAME"

# 验证服务状态
if ! systemctl is-active --quiet "$SERVICE_NAME"; then
    echo "❌ Shadowsocks-Rust 服务 ($SERVICE_NAME) 启动失败，请检查 systemctl status $SERVICE_NAME"
    exit 1
fi

# 获取公网 IP（优先 IPv4）
IP=$(curl -s -4 --connect-timeout 5 https://api64.ipify.org)
if [[ -z "$IP" ]]; then
    IP=$(curl -s -6 --connect-timeout 5 https://api64.ipify.org)
fi
if [[ ! "$IP" =~ ^[0-9.:]+$ ]]; then
    echo "❌ 无法获取有效公网 IP，请检查网络"
    exit 1
fi

# 构建标准 ss:// 链接
ENCODED=$(echo -n "$METHOD:$PASSWORD@$IP:$PORT" | base64 | tr -d '\n')
SS_LINK="ss://$ENCODED#$NODE_NAME_ENCODED"

# 输出节点信息和链接
echo -e "\n✅ Shadowsocks-Rust 节点 ($NODE_NAME) 已部署成功"
echo "-------------------------------------"
echo "节点名称: $NODE_NAME"
echo "地址: $IP"
echo "端口: $PORT"
echo "密码: $PASSWORD"
echo "加密: $METHOD"
echo "IPv6 支持: $HAS_IPV6"
echo "配置文件: $CONFIG_FILE"
echo "服务名称: $SERVICE_NAME"
echo -e "\n📎 标准链接：\n$SS_LINK"
